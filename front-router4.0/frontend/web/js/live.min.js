$.ajaxSetup({header:{"Content-type":"application/json"},cache:false});(function(W,D){var timeCount=W["timeCount"]=function(o){return new _timeCount(o)},_timeCount=function(o){this.leftTime=o.leftTime;this.dom=o.dom;this.format=o.format;this.callback=o.callback;this.time=0;this.i=0;this.flag=o.flag;this.lastTime=0||o.lastTime*60;this.period=o.period||1000;var _this=this;this.interval=setInterval(function(){_this.init();_this.callback&&_this.callback(_this.dom,_this.time)},this.period)};_timeCount.prototype={auto:function(){var _this=this;setTimeout(function(){_this.init();_this.callback&&_this.callback(_this.dom,_this.time)},1000)},ten:function(t){if(t<10){t="0"+t}return t},init:function(){var _this=this,time=0;if(_this.flag){var l=1}else{var l=-1}_this.i++;console.log("======",(_this.leftTime)/1000);_this.time=time=Math.round((_this.leftTime)/1000);_this.mtime=(_this.leftTime)/100;var str,str1;if(_this.lastTime!=0&&time>=_this.lastTime){}else{if(time>0){var day=_this.ten(Math.floor(time/(60*60*24))),hour=_this.ten(Math.floor(time/(60*60))-day*24),minute=_this.ten(Math.floor(time/60)-(day*60*24)-(hour*60)),second=_this.ten(Math.floor(time)-(day*24*60*60)-(hour*60*60)-(minute*60)),msecond=parseInt(_this.mtime%10);switch(_this.format){case 2:str=second;str1="00";break;case 4:str=minute+":"+second;str1="00:00";break;case 5:str=minute+":"+second+":"+msecond;str1="00:00:0";break;default:str=_this.ten(24*day+parseInt(hour))+":"+minute+":"+second;str1="00:00:00";break}var tArr=str.split(":"),_html="";tArr.map(function(item){_html+="<span>"+item+"</span>:"});_this.dom.show(200).find(".countDown").html(_html.substring(0,_html.length-1));_this.leftTime-=1000}else{switch(_this.format){case 2:str1="00";break;case 4:str1="00:00";break;case 5:str1="00:00:0";break;default:str1="00:00:00";break}var tArr=str1.split(":"),_html="";$.each(tArr,function(index,item){_html+="<span>"+item+"</span>:"});_this.dom.show().find(".countDown").html(_html.substring(0,_html.length-1));window.clearInterval(this.interval)}}}}})(window,document);var G={opt:{basePath:(window.location.pathname.indexOf("/test")>-1||window.location.host.indexOf("localhost:8080")>-1||window.location.host.indexOf("10.10.30.166:8080")>-1)?"/test":"",post_url:"https://apim.bolue.cn",static_url:"https://mb.bolue.cn",live_decode_arr:[["a","d","g","j","m","p","s","v","y","b"],["b","e","h","k","n","q","t","w","z","c"],["c","f","i","l","o","r","u","x","a","d"]]},txt_num_evt:function(){var _that=this;$(".txt_num_evt").not("[data-max]").each(function(index,el){var _p=$(el),obj=_p.find('input[type="text"],input[type="password"]'),error=_p.find(".error"),limit=($(el).data("limit")+"").split(",");!limit[1]&&(limit=[0,limit]);obj.length==0&&(obj=$(el).find("textarea"));_p.attr("data-max",limit[1]);obj.on("input",function(e){var length=Math.ceil(obj.val().ByteCount());if(length>limit[1]){obj.val(obj.val().subCHStr(0,limit[1]));_p.attr("data-str",limit[1])}else{_p.attr("data-str",length)}})})},for_tabs:function(callback){$(".tabs").on("click",".li",function(){var _t=$(this);_t.addClass("curr").siblings().removeClass("curr");_t.parent().parent().find(".page_list").find(".ul").eq(_t.index()).removeClass("hide").show().siblings(".ul").hide();"function"===typeof callback&&callback(_t)})},IsEmpty:function(o){if(o){return(typeof(o)=="string")?false:((typeof(o)==="object")?!this.ObjNotEmpty(o):o)}return true},ObjNotEmpty:function(o){if(typeof(o)==="object"&&!(o instanceof Array)){var hasP=false;for(var p in o){hasP=true;break}if(hasP){return true}else{return false}}else{if(o instanceof Array){return o.length==0?false:true}else{return o}}},show_noData:function(o,type){var cont='<img src="'+G.opt.static_url+G.opt.basePath+'/img/v2/icons/null@2x.png" alt="暂无相关数据" />';cont+="<p>暂无相关数据</p>";o.html("<div class='no_data'>"+cont+"</div>").fadeIn(400)},show_data:function(data,tmpl,obj,cleanObj,showNoData,callback,flag){var _that=this;showNoData=showNoData||("object"!==typeof cleanObj&&cleanObj);if(!G.IsEmpty(data)){flag?(obj.append(tmpl.tmpl(data)),obj.find(".no_data").hide()):obj.html(tmpl.tmpl(data));callback&&callback()}else{cleanObj&&cleanObj.hide();!!showNoData&&_that.show_noData(obj,showNoData)}},getCookie:function(e){var t=new RegExp("(^| )"+e+"(?:=([^;]*))?(;|$)"),res=document.cookie.match(t);return res?res[2]:""},setCookie:function(a,b,c,d,e){var f="",g="",i="";if(d){var j=document.location.hostname.match(/[a-z0-9][a-z0-9\-]+\.[a-z\.]{2,6}$/i),k=j?j[0]:"";f=k?"; domain=."+k:""}if(c){var l=new Date;l.setTime(l.getTime()+24*c*60*60*1000),g="; expires="+l.toGMTString()}e&&(i="; secure");return(document.cookie=a+"="+encodeURIComponent(b)+g+"; path=/"+f+i)},show_alert:function(con){var obj=$("#alert");if($("#liveAsk").is(":visible")){obj.css({"top":"auto","bottom":"30%"})}else{obj.css({"top":"50%","bottom":"auto"})}obj.html(con).show();setTimeout(function(){obj.hide()},5000)}};G.live={canSpeak:1,canSubmitTimes:0,InterValObj:null,getData:function(target){var pathname=window.location.pathname,n=pathname.lastIndexOf("/"),id=pathname.substr(n+1);
$("#resourceId").val(id);var o={};if(target.header&&target.header.bolueclient){o=target.header}else{o.bolueclient=G.getCookie("bolueClient");o.boluever=G.getCookie("bolueVer");o.myauth='{"openid":"'+G.getCookie("openid")+'", "code":"'+G.getCookie("code")+'"}'}$.ajaxSetup({beforeSend:function(xhr,ajaxObj){if(ajaxObj.url.indexOf("bolue.cn/")>-1){xhr.setRequestHeader("bolueClient",o.bolueclient);xhr.setRequestHeader("bolueVer",o.boluever);xhr.setRequestHeader("MyAuth",o.myauth);xhr.setRequestHeader("Content-type","application/json")}}});$.ajax({type:"POST",url:G.opt.post_url+G.opt.basePath+"/v2/enterLiveRoom/"+id+"?random="+Math.random(),success:function(data){if(data&&data.err){G.show_alert(data.err||"当前直播无法播放，请退出并重新进入");TDAPP.onEvent("进入直播间","出错信息",o)}else{$("#gonggao .cTime").text(data.result.cTime);document.title=data.result.title;$("#navG .tit").text(data.result.title);data.result["source"]=o.bolueclient=="ios"?3000000000:(o.bolueclient=="android"?4000000000:(o.bolueclient=="wap"?2000000000:0));target.callback&&target.callback(data.result);TDAPP.onEvent("观看直播","信息",data.result)}},error:function(err){G.show_alert("当前直播无法播放，请退出并重新进入");TDAPP.onEvent("进入直播间","出错信息",o)}})},newPlay:function(o){var _that=this;var setRH=function(){$("#chatParts .page_list").height($(window).height()-$("#player").height()-$("#chatParts .tabs").height()-($("#navG").is(":visible")?$("#navG").height():0))};setRH();$(window).on("resize",setRH);_that.showHideGG();$(document).on("click",".close",function(event){$(this).parent().hide("slow");$("#mask").hide()});$("#liveAsk .close").on("touchstart",function(){var msgB=document.getElementById("pub_message_textarea");$(msgB).blur();$(msgB).parents(".live_ask").hide();$("#mask").hide()});if(o&&o.userId&&o.roomId){var liveplayer=polyvObject("#player").livePlayer({"forceH5":true,"banMultirate":true,"width":"100%","height":"100%","uid":o.userId,"vid":o.roomId,"param1":parseInt(o.accountId)+o.source});$("#submitPubChat").on("touchstart",function(){G.live.submitPubChat(o)})}else{G.show_alert("播放器加载失败，请联系铂略客服")}var supportsWebSockets="WebSocket" in window||"MozWebSocket" in window;var chatHost="https://chat.polyv.net";try{socket=io.connect(chatHost,{query:"token="+o.accountId,transports:[supportsWebSockets?"websocket":"polling"]});socket.emit("message",JSON.stringify({EVENT:"LOGIN",values:[o.userNick,o.userPic,o.accountId],roomId:o.roomId,type:"student",}))}catch(e){G.show_alert("请检查您的网络并重试")}$("#forChat").click(function(){$("#liveAsk,#mask").show();$("#pub_message_textarea").focus()});try{$.get("//apichat.polyv.net/front/history",{roomId:o.roomId,start:0,end:-1,hide:0},function(d){_that.showSPEAK(d)});$.get("//apichat.polyv.net/front/getQuestionContent",{roomId:o.roomId,start:0,end:-1},function(d){_that.showQA(d)})}catch(e){}try{socket.on("message",function(event){console.dir(event);var mData=JSON.parse(event);if(mData&&mData.EVENT){switch(mData.EVENT){case"BULLETIN":_that.showBULLETIN(mData.content);break;case"LOGIN"||"LOGOUT":break;case"SPEAK":_that.showSPEAK([mData],1);mData.user&&_that.showTips(0);break;case"REMOVE_CONTENT":_that.fireREMOVE_CONTENT(mData);_that.showTips(0);break;case"S_QUESTION":_that.showQA([mData],1);break;case"T_ANSWER":_that.showQA([mData],1);break;case"BANIP":_that.canSpeak=0;G.show_alert("您已被禁言");break;case"UNSHIELD":_that.canSpeak=1;G.show_alert("您已被取消禁言，可正常互动");break;case"REMOVE_HISTORY":$("#publicChat").html("");G.show_alert("讲师刚刚打扫了直播大厅");break;case"SIGN_IN":$("#LiveComment,#mask").show();break}}})}catch(e){G.show_alert("检测到您的通讯不稳定，请联系铂略客服")}$("#LiveComment .pingjia").on("click",".star",function(event){event.preventDefault();var _t=$(this);_p=_t.parent(".pingjia");var str="https://mb.bolue.cn/test/img/v2/icons/",starOff="Star_full.png",starOn="Star_null.png";var n=_t.index();_p.find(".star:lt("+(n+1)+")").addClass("full").removeClass("null");_p.find(".star:gt("+(n)+")").removeClass("full").addClass("null");$("#pingfenC").text(_p.find(".full").length)})},canSub:1,add_mark:function(dom){var _that=this,_this=$(dom),_parents=_this.parents(".main_c");var resourceId=$("#resourceId").val();var star=$("#pingfenC");var content=_parents.find(".miaoshu");if(_that.canSub){if(star.text()=="0"){G.show_alert("请先打分");return}_that.canSub=0;$.post(G.opt.post_url+G.opt.basePath+"/v2/addComment",JSON.stringify({"resourceId":resourceId,"star":star.text(),"resourceType":1,"content":content.val(),"label":null}),function(d){_that.canSub=1;if(d.result){content.val("");$("#LiveComment,#mask").hide();TDAPP.onEvent("直播间评分数据","直播课Id："+resourceId,{"accountId":$("#accountId").val(),"star":star.text(),"content":content.val()});G.show_alert("我们已经收到您的评价，谢谢")}else{TDAPP.onEvent("直播间评分数据","评分出错：",{"resourceId":resourceId,"accountId":$("#accountId").val(),"star":star.text(),"content":d.err});G.show_alert(d.err)}})}else{G.show_alert("正在提交，请稍候")}},showQA:function(d,flag){var _that=this,n=d.length||0,me=$("#accountId").val(),arr=[];if(d&&n>0){n=0;while(n<d.length){var dd=d[n],user=dd.user;dd["cls"]="right";
if(!dd.time){dd["time"]=new Date()}if(dd.s_userId&&dd.s_userId==me){dd["cls"]="left";user.nick="讲师";arr.push(dd);_that.showTips(1)}else{if(user.userId==me){user.nick="我";arr.push(dd)}}n++}}var parent=$("#myQA");G.show_data(arr,$("#myQA_tmpl"),parent,null,null,null,flag);parent[0].scrollTop=parent[0].scrollHeight},fmt_time:function(t){return t?new Date(t).format("hh:mm:ss"):new Date().format("hh:mm:ss")},fireREMOVE_CONTENT:function(s){if(s.id){$("#publicChat").find("li[id="+s.id+"]").html('<div class="rollback">讲师&nbsp;撤回了一条互动</div>')}},showLOGIN:function(s){$("#uCounts").text(s);TDAPP.onEvent("直播人数变化",s)},showBULLETIN:function(s){var _that=this;$(".p_live .gonggao .cont").text(s);_that.showHideGG()},showSPEAK:function(d,flag){var n=d.length||0,me=$("#accountId").val(),arr=[];if(d&&n>0){while(n>0){n--;var dd=d[n],user=dd.user||{};if(user.userType){dd["flag"]="1";if(!dd.time){dd["time"]=new Date()}if(user.userType!="student"){user.nick="公开回答";dd["flag"]="0";user.nick="讲师";arr.push(dd)}else{if(user.userId==me){user.nick="【我】"}arr.push(dd)}}}}var parent=$("#publicChat");G.show_data(arr,$("#publicChat_tmpl"),parent,null,null,null,flag);parent[0].scrollTop=parent[0].scrollHeight},clearName:function(str){return str?str.split("——")[0].subCHStr(0,16):""},submitPubChat:function(o){var _that=this;if(_that.canSpeak){var msgB=document.getElementById("pub_message_textarea"),msg=msgB.value;if(G.IsEmpty(msg)){G.show_alert("输入内容不能为空");return}try{if(_that.canSubmitTimes<=0){socket.emit("message",JSON.stringify({EVENT:"SPEAK",values:[msg],roomId:o.roomId}));socket.emit("message",JSON.stringify({EVENT:"S_QUESTION",roomId:o.roomId,user:{nick:o.userNick,pic:o.userPic,userId:o.accountId,userType:"student"},content:msg}),function(){G.show_alert("您的问题已经提交成功，请耐心等待回复");TDAPP.onEvent("直播间互动数据","直播课Id："+$("#resourceId").val(),{"nick":o.userNick,"accountId":o.accountId,"content":msg})});msgB.value="";$(msgB).parent(".live_ques").attr("data-str",0);$(msgB).blur();$("#mask").hide();$(msgB).parents(".live_ask").hide();_that.canSubmitTimes=30;_that.InterValObj=window.setInterval(function(){if(_that.canSubmitTimes>0){_that.canSubmitTimes--}else{window.clearInterval(_that.InterValObj)}},1000)}else{G.show_alert("您的发言过快，请稍候重试")}}catch(e){}}else{G.show_alert("您已被禁言")}},showHideGG:function(){$("#gonggao,#mask").show("fast");setTimeout(function(){$("#gonggao").is(":visible")&&$("#gonggao,#mask").hide("slow")},10000)},showTips:function(type){var obj=$("#chatParts .tabs");obj.children(".curr").index()!=type&&(obj.children(".li").eq(type).addClass("redTips"))},phoneValid:function(phone){return typeof("")===typeof(phone)?/^1[0-9]{10}$/.test(phone):!!0}};String.prototype.strToCharsCH=function(){for(var a=new Array,b=0;b<this.length;b++){a[b]=[this.substr(b,1),this.isCHS(b)]}return String.prototype.charsArray=a,a};String.prototype.isCHS=function(a){return this.charCodeAt(a)>255||this.charCodeAt(a)<0?!0:!1};String.prototype.subCHString=function(a,b){var c=0,d="";this.strToCharsCH();for(var e=0;e<this.length;e++){if(this.charsArray[e][1]?c+=2:c++,c>b){return d}c>a&&(d+=this.charsArray[e][0])}return d};String.prototype.subCHStr=function(a,b){return this.subCHString(a,a+b)};String.prototype.ByteCount=function(){var d=0;this.strToCharsCH();for(var e=0;e<this.length;e++){this.charsArray[e][1]?d+=2:d++}return d};Date.prototype.format=function(format){var o={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),"S":this.getMilliseconds()};if(/(y+)/.test(format)){format=format.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length))}for(var k in o){if(new RegExp("("+k+")").test(format)){format=format.replace(RegExp.$1,RegExp.$1.length==1?o[k]:("00"+o[k]).substr((""+o[k]).length))}}return format};G.live_invite={opt:{bolueclient:"wap",boluever:"2.4.30",myauth:'{"openid":"'+G.getCookie("openid")+'", "code":"'+G.getCookie("code")+'"}',},checkValid:function(){},init:function(header){var _that=this;G.setCookie("bolueClient",_that.opt.bolueclient);G.setCookie("bolueVer",_that.opt.boluever);_that.getData(header);$("#accountList").on("click",".li",function(event){var _t=$(this);_t.addClass("curr").siblings(".li").removeClass("curr")}).on("click",".sure button",function(event){_that.liveLogin($(this).parents(".account_list").find(".li.curr").attr("data-uuid"))});$('.input_li .ipt_box input[type="text"]').on("focus",function(){var _t=$(this);if(_t.parents(".live_login").hasClass("can_submit")){_t.parents(".input_li").addClass("focus")}}).on("blur",function(){var _t=$(this);if(_t.parents(".live_login").hasClass("can_submit")){_t.parents(".input_li").removeClass("focus")}});$(".input_li .ipt_box .get_phone_code").on("click","",function(){var _t=$(this);if(_t.parents(".live_login").hasClass("can_submit")){if(!_t.hasClass("disabled")){sendSmsCode(0)}}});$(".live_login .operate").on("click",function(){var _t=$(this);if(_t.parents(".live_login").hasClass("can_submit")){G.live_invite.liveLogin()
}else{G.show_alert("请输入正确的信息")}})},getData:function(header){var pathname=window.location.pathname,n=pathname.lastIndexOf("/"),idstr=pathname.substr(n+1),id=G.live_invite.decryptoGraph(idstr);$("#resourceId").val(id);var o={};if(header&&header.bolueclient){o=target.header}else{o.bolueclient=this.opt.bolueclient;o.boluever=this.opt.boluever;o.myauth=this.opt.myauth}$.ajaxSetup({beforeSend:function(xhr,ajaxObj){if(ajaxObj.url.indexOf("bolue.cn/")>-1){xhr.setRequestHeader("bolueClient",o.bolueclient);xhr.setRequestHeader("bolueVer",o.boluever);xhr.setRequestHeader("MyAuth",o.myauth);xhr.setRequestHeader("Content-type","application/json")}}});$.ajax({type:"GET",url:G.opt.post_url+G.opt.basePath+"/v2/inviteLiveDetail/"+id+"?random="+Math.random(),success:function(data,status,xhr){if(data&&data.err){G.show_alert(data.err||"当前直播课已下架")}else{var _result=data.result;$(".live_tit").text(_result.title);document.title="铂略直播体验-"+_result.title;var _liveDate=new Date(_result.start_time).format("yyyy-MM-dd");var _time=new Date(_result.start_time).format("hh:mm")+"-"+new Date(_result.end_time).format("hh:mm");$("#live_time").text(_liveDate+" "+_time);if(_result.status==1){$(".live_login").addClass("can_submit")}else{$(".live_login").removeClass("can_submit");if(_result.status==2){$(".live_login .operate span").text("本次直播已结束")}else{if(_result.leftTime){if(_result.leftTime>30*60*1000){$(".login_tips .open_time").show();$(".countDownBox").hide()}else{timeCount({dom:$(".countDownBox"),leftTime:_result.leftTime-15*60*1000,flag:0,lastTime:15,period:1000,format:4,callback:function(dom,cur_time){cur_time<=1&&cur_time>=0&&window.location.reload()}})}}}}window.share_config={title:_result.title,desc:_result.brief,link:document.location.href+"",imgUrl:_result.brief_image,type:"link",success:function(){},}}},error:function(err){G.show_alert("当前直播无法播放，请退出并重新进入")}})},liveLogin:function(uuid){var _that=this;var phone=$(".input_li .ipt_box.phone input").val();var verifyCode=$(".input_li .ipt_box.input_short input").val();var pathname=window.location.pathname,n=pathname.lastIndexOf("/"),idstr=pathname.substr(n+1),id=G.live_invite.decryptoGraph(idstr);if(G.live.phoneValid(phone)){$.ajax({url:G.opt.post_url+G.opt.basePath+"/v2/inviteLiveLogin/?random="+Math.random(),type:"POST",headers:{"Accept":"application/json","Content-Type":"application/json"},data:JSON.stringify({userName:phone,verifyCode:verifyCode,uuid:uuid,liveId:id}),success:function(data){console.log(data);if(data&&data.err){G.show_alert(data.err);return false}var res=data.result;$("#accountList").hide();if(res.needBind){var _tar=$("#alertTips");_tar.find(".operate .btn").attr("href",window.location.origin+"/lesson/live/"+id);_tar.show();var i=5;setInterval(function(){i--;if(i==0){window.location.href=window.location.origin+"/lesson/live/"+id}_tar.find(".time").text(i)},1000);$("#mask").show()}else{if(res.length>0){G.show_data(res,$("#accountList_tmpl"),$("#accountList .list"),null,null,null);$("#accountList").show()}else{if(data.user.isLogined){localStorage.setItem("credentials.code",res.code);localStorage.setItem("credentials.openid",res.openid);localStorage.setItem("bolueClient",_that.opt.bolueclient);localStorage.setItem("boluever",_that.opt.boluever);G.setCookie("openid",res.openid);G.setCookie("code",res.code);var _url=window.location.pathname.indexOf("/test/")==0?"/test":"";if(res.authority){window.location.href=window.location.origin+_url+"/livePlay/"+id}else{window.location.href=window.location.origin+_url+"/lesson/live/"+id}}else{G.show_alert("本次直播已结束")}}}},error:function(err){G.show_alert("网络实在不给力，请再来一次")}})}else{G.show_alert("请输入正确的手机格式")}},decryptoGraph:function(str){var decodeArr=G.opt.live_decode_arr[0],resultArr=[];if(str.length<2){return 0}for(i=0;i<str.length;i++){if(i==0){if(!/[0-2]/.test(str.charAt(i))){resultArr.push(0);return 0}decodeArr=G.opt.live_decode_arr[str.charAt(i)]}else{if(decodeArr.indexOf(str.charAt(i))>-1){resultArr.push(decodeArr.indexOf(str.charAt(i)))}else{return 0}}}if(resultArr.length==str.length-1){return parseInt(resultArr.join(""))}else{return 0}}};